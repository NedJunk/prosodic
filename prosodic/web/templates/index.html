<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="/static/jquery.dataTables.min.css" />
<script type="text/javascript" src="/static/jquery-3.7.1.slim.min.js"></script>
<script type="text/javascript" src="/static/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/static/progressbar.js"></script>
<link rel="stylesheet" type="text/css" href="/static/style.css" />



</head>
<body>
    <div id='progressbar'></div>

  
  <div id="layout">

    <div id="sidecol">
        <div id='header'>
            <h1 id='title'>Prosodic [prə.'sɑ.dɪk]</h1>
            <div id='subtitle'>A metrical parser, written in Python. For English and Finnish, with flexible language support.</div>      
          </div>
          
        <div id="inputformdiv">
            <form onsubmit="return send(event)" id="inputform">

                <!-- <h3>Parse text:</h3> -->
                <textarea id="inputtext" name="text">From fairest creatures we desire increase,
That thereby beauty's rose might never die,
But as the riper should by time decease,
His tender heir might bear his memory:
But thou, contracted to thine own bright eyes,
Feed'st thy light'st flame with self-substantial fuel,
Making a famine where abundance lies,
Thyself thy foe, to thy sweet self too cruel.
Thou that art now the world's fresh ornament
And only herald to the gaudy spring,
Within thine own bud buriest thy content
And, tender churl, makest waste in niggarding.
Pity the world, or else this glutton be,
To eat the world's due, by the grave and thee.
</textarea>

<div id="parsebtndiv">
    <button id="parsebtn" type="submit">Parse</button>
</div>

<hr/>

            <div class="config-group">
                <label class="title">Configure metrical constraints</label>
                {% for cname in constraints %}
                    <li class="flex-box">
                        <label for="{{cname}}">{{cname}}</label>
                        <input type="checkbox" class="flex-box-2" id="{{cname}}" name="{{cname}}" value="1" {% if cname in active_constraints %}checked{%endif%}>
                    </li>
                {% endfor %}
            </div>

            <div class="config-group">
                <label for="max_w"  class="title">Adjust maximum # of syllables in a metrical position</label>

                {% for maxx in ["max_w","max_s"] %}

                    <li class = 'flex-box'>
                        <label for="{{maxx}}">{{maxx}}</label>
                        <select class="flex-box-2" name="{{maxx}}" id="{{maxx}}">
                            {% for num in range(10) %}
                                <option value={{num+1}}>{{num+1}}</option>
                            {%endfor%}
                        </select>
                    </li>

                {% endfor %}
                
            </div>

            <div class="config-group">
                <label class="title">Configure thoroughness of parser</label>
                <li class="flex-box">
                    <label for="resolve_optionality">{{cname}}</label>
                    <input type="checkbox" class="flex-box-2" id="{{cname}}" name="{{cname}}" value="1" {% if cname in active_constraints %}checked{%endif%}>
                </li>

                
            </div>

            

            
            </form>
        </div>

        
    </div>

    <div id="maincol">
        <div id="parseresults">
            <table id="table_lines">
                <thead>
                    <th>Stanza</th>
                    <th>Line</th>
                    <th>Rank</th>
                    <th>Parse</th>
                    <th>Ambiguity (#parses)<!--<small>(per 10 sylls)</small>--></th>
                    <th>Tension (#viols)<!--<small>(per 10 sylls)</small>--></th>
                    {% for cname in constraints %}
                    <th>*{{cname.replace("_"," → ")}} <!--<small>(per 10 sylls)</small>--></th>
                    {%endfor%}
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    

  </div>


<!-- JAVASCRIPT -->

<script type="text/javascript">


    const ws = new WebSocket(`ws://${location.host}/ws`);

    var table = $('#table_lines').DataTable({
        dom: 'Bfrtip',
        buttons: [
            'copy', 'excel', 'pdf'
        ],
        fixedHeader: true,
        // data:[],
        // columns: ['#', 'Line'],
        pageLength: 50,
        order: [[ 0, "asc" ], [ 1, "asc" ], [ 2, "asc" ]],
        columnDefs: [
            { "width": "50px", "targets": 0 },
            { "width": "50px", "targets": 1 },
            { "width": "100%", "targets": 2 },
            { "width": "50px", "targets": 3 },
            { "width": "50px", "targets": 4 },
            {% for i,x in enumerate(constraints) %}
            { "width": "50px", "targets": {{i+5}} },
            {%endfor%}
        //   { "width": "300px", "targets": 2 },
        //   { "width": "100px", "targets": 3 }
        ]
    });

    var bar = new ProgressBar.Circle('#progressbar', {
        color: '#aaa',
        // This has to be the same size as the maximum width to
        // prevent clipping
        strokeWidth: 6,
        trailWidth: 1,
        // easing: 'easeInOut',
        duration: 0,
        text: {
        autoStyleContainer: false
        },
        from: { color: '#aaa', width: 1 },
        to: { color: '#333', width: 4 },
    });
    bar.setText('ready');
    bar.text.style.fontFamily = '"Raleway", Helvetica, sans-serif';
    bar.text.style.fontSize = '.8rem';
    bar.text.style.margin = '0 auto';

    function submit() {
        data = $('#inputform').serializeArray();
        console.log(data);
        table.clear();
        bar.set(0.0);
        if (data) {
            ojson = JSON.stringify(data);
            ws.send(ojson); 
        }
    }

    ws.addEventListener('message', function (event) {
        data = JSON.parse(event.data);
        console.log(data);
        bar.animate(data.progress);
        if (data.progress!=1) {
            remaining = Math.round(data.remaining);
            if (remaining==0) { remaining = '<1'} else { remaining = remaining.toString(); }
            progress = Math.round(data.progress * 100);
            bar.setText(progress.toString() + '%\n' + remaining+ 's');
        } else {
            let pbtn = $('#parsebtn');
            pbtn.html('Parse');
            pbtn.prop("disabled",false);
            bar.setText('done');
        }
        
        table.row.add(data.row).draw();
    });

    $('#parsebtn').on('click', function() { 
        let pbtn=$('#parsebtn');
        pbtn.html('Parsing...');
        pbtn.prop("disabled",true);
        submit();
    });


    // A $( document ).ready() block.
    $( document ).ready(function() {
        setTimeout(function() { $('#parsebtn').click(); }, 500);
    });


</script>
</body>
</html>